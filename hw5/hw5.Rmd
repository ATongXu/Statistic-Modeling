---
title: "大学生恋爱情况影响因素"
author: 徐竞桐
output: 
  html_document:
    df_print: paged
---

##  一、准备工作
```{r message = FALSE}
# 清除工作环境
rm(list=ls())
# 解决Mac OS系统下R绘图不显示中文的问题
library("showtext")
showtext_auto(enable = TRUE)
font_add("Songti",regular = "/System/Library/Fonts/Supplemental/Songti.ttc")
quartz(family = "Songti")
```

## 二、查看数据情况，数据预处理

```{r message=FALSE}
dat = read.csv("/Users/xujingtong/my/大三上/统计建模/数据/大学生恋爱数据.csv", 
               header = TRUE, fileEncoding = "GBK")                             # 导入数据，使用GBK编码识别中文
head(dat)                                                                       # 查看数据集的前几行
## 将所有字符串变为数字
# 替换数据中的“是”“否”
dat[dat == "是"] = 1
dat[dat == "否"] = 0
# 替换年级中的“大一”“大二”“大三”“大四”
dat[dat == "大一"] = 1
dat[dat == "大二"] = 2
dat[dat == "大三"] = 3
dat[dat == "大四"] = 4
# 替换性别中的“男”“女”
dat[dat == "女"] = 0
dat[dat == "男"] = 1
# 替换家乡中的字符串
dat[dat == "1一线城市"] = 1
dat[dat == "2二线城市"] = 2
dat[dat == "3三线城市"] = 3
dat[dat == "4县级市"] = 4
dat[dat == "5农村"] = 5
dat = as.data.frame(lapply(dat, as.numeric))                                    # 将数据框中的数据变为数值型

summary(dat)                                                                    # 查看数据集的描述统计结果
```

## 三、描述性分析

#### 1. 因变量与10个定量自变量的关系

```{r}
sequ = c(6:10,26,27,29,30,32)                                                   # 挑选出定量自变量
columns = c("每周自习时间","每周娱乐时间","每周睡觉时间","每周运动时间",
            "每月话费", "成绩水平", "生活费_百元", "身高", "体重", "颜值")      # 定量自变量的名称
par(mfrow = c(1,2))                                                             # 一次展示两幅图
for (i in 1:10){
  boxplot(dat[,sequ[i]]~dat[,1], xlab = columns[i])                             # 对于每个定型自变量绘制箱线图
}
```

**解读**：

为了大致了解是否脱单与哪些连续变量有关，绘制了是否脱单与所有连续变量的棘状图，便于挑选有效的变量。在此我们挑选因变量分别为恋爱和不恋爱时，分布呈现较大差异的自变量为较合适的自变量，进行下一步的建模。通过此10张图，认为“每月话费”“成绩水平”“体重”“颜值”这4个变量对因变量是否恋爱有较为明显的影响。

对于这4个变量，“每月话费”体现的是通话时长，处在恋爱中的人往往会打长时间的电话和伴侣交流，所以通话时长更长。“成绩水平”往往和投入时间成正比，需要大量时间的投入，才能获得优异的成绩，但是维持爱情关系也需要大量的时间精力，因此重视成绩的会往往会选择不恋爱来时精神更加集中。“体重”“颜值”体现的是大学生的审美取向，大家往往偏爱高颜值，身材较瘦的人。


#### 2. 因变量与18个二分类自变量的关系

```{r}
sequ = c(3,4,5,12:24,28,31)                                                     # 挑出二分类自变量
columns = c("性别","是否追求过别人","是否被别人追求过","班干部",
            "党员", "足球", "篮球", "乒乓球", "羽毛球", "跑步", 
            "台球", "唱歌", "主持", "舞蹈", "乐器", "其他才艺",
            "寝室同学是否谈过恋爱", "是否戴眼镜")                               # 二分类自变量的名称
par(mfrow = c(1,2))                                                             # 一次展示两幅图
for (i in 1:18){
  table1 = table(dat[,sequ[i]],dat[,1])                                         # 统计分类变量各种取值情况下因变量的取值
  spineplot(table1, xlab = columns[i])                                          # 对于每个二分类自变量绘制棘状图
}
```

**解读**：

为了大致了解是否脱单与哪些变量有关，绘制了是否脱单与所有二分变量的棘状图，便于挑选有效的变量。在此我们挑选自变量取两种不同的值时，因变量是否脱单的人数占比区别较大的作为适宜的变量，进行下一步的建模。通过此18张图，认为“是否追求过别人”“是否被别人追求过”“篮球”“乒乓球”“台球”“主持”“寝室同学是否谈过恋爱”这7个变量对因变量是否恋爱有较为明显的影响。

对于这7个变量，“是否追求过别人”体现的是对于恋爱的积极性，有追求经验说明愿意投入恋爱中，自然恋爱的人数较多。“是否被别人追求过”“篮球”“乒乓球”“台球”“主持”体现的是个人魅力，一个人被人追求过说明他作为伴侣较为优秀，而其他几项均是才艺，此类才艺掌握者往往更有魅力（乒乓球除外，可能是此类活动过于大众，反而起到了反作用），追求者也会更多，因此更有可能恋爱。“寝室同学是否谈过恋爱”体现的是环境的影响，对于大学生，舍友是朝夕相处的伙伴，当舍友在恋爱中时，由于跟风的心理，他往往会更渴望恋爱，因此在更有可能脱单。


#### 3. 因变量与3个多分类自变量的关系

```{r message = FALSE}
par(mfrow = c(1,1))                                                             # 一次展示一幅图
table1 = table(dat$年级,dat$是否恋爱)
spineplot(table1)                                                               # 绘制是否恋爱关于年级的棘状图
table1 = table(dat$学生组织个数,dat$是否恋爱)
spineplot(table1)                                                               # 绘制是否恋爱关于学生组织个数的棘状图
table1 = table(dat$家乡,dat$是否恋爱)
spineplot(table1)                                                               # 绘制是否恋爱关于家乡的棘状图
```

**解读**：

为了大致了解是否脱单与哪些多分类自变量有关，绘制了是否脱单与它们的棘状图，便于挑选有效的变量。在此我们挑选自变量取不同的值时，因变量是否脱单的人数占比区别较大的作为适宜的变量，进行下一步的建模。通过此3张图，认为“年级”“学生组织个数”这2个变量对因变量是否恋爱有较为明显的影响。

“年级”对是否恋爱有较大的影响是因为开始恋爱关系是需要一段较长的时间来相互了解的，而大一，大二的学生在学校中属于新生，没有充足的时间和其他同学相互了解，而大三，大四的同学往往社交范围更广，认识的人更多，与人相处的时间更长，更有可能和别人发展起恋爱关系。“学生组织个数”体现了一个学生的社交能力，参加组织越多的人往往社交能力越强，认识的人群越广，所以越有可能脱单。

## 四、建立广义线性回归模型

### 全模型检验

```{r}
## 建立广义线性回归模型
glm1 = glm(是否恋爱~每月话费+颜值+成绩水平+体重+是否追求过别人+是否被别人追求过+篮球
               +乒乓球+台球+主持+寝室同学是否谈过恋爱+年级+学生组织个数, 
               data = dat, family = binomial(link = "logit"))                   # 根据挑选的变量建立模型
## 全模型显著性检验
glm_null = glm(是否恋爱~1, data = dat, family = binomial(link = "logit"))       # 建立一个空的广义线性回归模
anova(glm1, glm_null, test = "LRT")                                             # 进行似然比检验
```

**解读**：

建立是否恋爱关于所选自变量的广义线性线性回归模型如上所示。全模型假设检验的p值远远小于0.05，模型显著，拒绝原假设所有自变量系数为0，所以该回归模型存在。

### 模型解读

```{r}
summary(glm1)                                                                   # 展示模型结果
```

**解读**：

在0.05的显著性水平下，改模型中自变量“是否追求过别人”“是否被别人追求过”“乒乓球”“台球”“寝室同学是否谈过恋爱”这5个自变量的系数假设检验p值显著，拒绝原假设，认为这5个变量的系数不为0。说明这5个变量对因变量是否脱单有明显影响。

其中“是否追求过别人”“是否被别人追求过”“台球”“寝室同学是否谈过恋爱”的拟合系数为正，说明当一个学生追求过别人，被别人追求过，会打台球，或寝室同学谈过恋爱，那么这位同学自己太恋爱的可能性就越大。而“乒乓球”的拟合系数为负，说明如果这位同学会打乒乓球，则他谈恋爱的可能性就越小。可能原因在描述性分析中已有阐释。


### 根据模型进行预测

```{r}
Ypro = glm1$fitted.values                                                       # 提取模型对于是否恋爱概率的预测
hatY = 1*(Ypro>mean(dat$是否恋爱))                                              # 挑选阈值，将预测的概率转变为是否恋爱的取值
H = table(dat$是否恋爱,hatY)                                                    # 展示混淆矩阵
fault = (H[1,2]+H[2,1]) / sum(H)                                                # 错分率
TPR = H[2,2] / (H[2,1]+H[2,2])                                                  # 恋爱的人中有多少被正确预测
FPR = H[1,2] / (H[1,1]+H[1,2])                                                  # 非恋爱的人中有多少被错误预测
data.frame(预测值N = c(H[1,1],H[2,1],H[1,1]+H[2,1]),
           预测值P = c(H[1,2],H[2,2],H[1,2]+H[2,2]),
           总计 = c(H[1,1]+H[1,2],H[2,1]+H[2,2],sum(H)))                        # 展示混淆矩阵
data.frame(错分率 = fault, TPR = TPR, FPR = FPR)                                # 展示错分率、TPR、FPR

```


**解读**：

挑选数据集因变量出现是的频率为阈值，将预测值中大于阈值的定为恋爱，小于的定为不恋爱。得到混淆矩阵如上。预测为恋爱的有178人，预测为非恋爱的有115人，该模型的错分率为19.45%。正确判断为恋爱的比例TPR为78.67%，错误判断为恋爱的比例FPR有14.63%，模型有一定的预测能力。

### 模型评价

```{r error = FALSE}
library(pROC)
Y = dat$是否恋爱
r = roc(Y, Ypro)
plot.roc(r,print.auc = T, print.thres = T)
```

**解读**：
上图为该模型的ROC曲线，ROC曲线下方面积AUC值为0.869，认为该模型对于因变量是否恋爱有不错的解释能力。











